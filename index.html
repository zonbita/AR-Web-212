<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR Multi-Animation with Sound</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    body { margin:0; display:flex; flex-direction:column; align-items:center; background:#111; color:#fff; font-family:sans-serif; }
    model-viewer { width:100%; height:80vh; background:#222; }
    audio { display:none; }
  </style>
</head>
<body>
  <model-viewer id="mv"
    src="model.glb"
    ios-src="model.usdz"
    ar
    ar-modes="scene-viewer quick-look webxr"
    autoplay
    camera-controls
    shadow-intensity="1"
    environment-image="neutral"
    animation-crossfade-duration="500">
  </model-viewer>

  <audio id="sfx"></audio>

  <script>
    const mv = document.getElementById('mv');
    const audio = document.getElementById('sfx');

    // Map animations â†’ sounds (replace with your files)
    const animationSounds = {
      "Idle": "idle.mp3",
      "Walk": "walk.mp3",
      "Run": "run.mp3",
      "Jump": "jump.mp3"
    };

    let animations = [];
    let currentIndex = 0;
    let isPlaying = false;

    mv.addEventListener('load', () => {
      animations = mv.availableAnimations;
      console.log("Animations found:", animations);
      if (animations.length > 0) {
        playAnimation(0);
      }
    });

    function playAnimation(index) {
      currentIndex = index;
      const animName = animations[currentIndex];
      console.log("Playing animation:", animName);

      // Play animation with crossfade
      mv.play({ animationName: animName, repetitions: 1 });

      // Play matching audio if available
      if (animationSounds[animName]) {
        audio.src = animationSounds[animName];
        audio.currentTime = 0;
        audio.play();
      }

      isPlaying = true;

      // Schedule next animation after current ends
      const duration = mv.animationDuration * 1000; // ms
      setTimeout(() => {
        fadeOutAudio(() => {
          const nextIndex = (currentIndex + 1) % animations.length;
          playAnimation(nextIndex);
        });
      }, duration - 500); // subtract crossfade time
    }

    function fadeOutAudio(callback) {
      let vol = 1.0;
      const fade = setInterval(() => {
        vol -= 0.1;
        if (vol <= 0) {
          clearInterval(fade);
          audio.pause();
          audio.currentTime = 0;
          callback();
        } else {
          audio.volume = vol;
        }
      }, 50);
    }
  </script>
</body>
</html>
