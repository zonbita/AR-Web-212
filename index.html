<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tap‑to‑Place AR (iPhone + Android)</title>
  <!-- model-viewer: WebXR + Android Scene Viewer + iOS Quick Look -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <!-- Preload USDZ so iOS can fetch it with the right MIME type -->
  <link rel="preload" as="fetch" href="/assets/model.usdz" type="model/vnd.usdz+zip" crossorigin>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0c10; color:#eee; }
    .wrap { min-height: 100%; display: grid; grid-template-rows: 1fr auto; }
    header { position: absolute; inset: 0 auto auto 0; padding: 12px 14px; z-index: 2; }
    header .badge { background: rgba(0,0,0,.55); border: 1px solid rgba(255,255,255,.12); padding: 8px 10px; border-radius: 12px; backdrop-filter: blur(6px); }

    model-viewer { width: 100%; height: 100vh; --poster-color: #0b0c10; }

    .controls { position: absolute; left: 50%; bottom: 20px; transform: translateX(-50%); z-index: 3; display:flex; gap:10px; }
    .controls button { 
      padding: 12px 18px; border-radius: 999px; border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08); color: #fff; font-weight: 600; letter-spacing: .2px; 
      box-shadow: 0 10px 24px rgba(0,0,0,.35); backdrop-filter: blur(8px);
    }
    .controls button:active { transform: translateY(1px); }

    .hint { position: fixed; left: 50%; top: 16px; transform: translateX(-50%); z-index: 3; display: none; }
    .hint .chip { background: rgba(0,0,0,.6); border: 1px solid rgba(255,255,255,.15); padding: 10px 14px; border-radius: 14px; }
    model-viewer[ar-status="session-started"] ~ .hint { display: block; }

    .diag { position: fixed; right: 10px; bottom: 10px; font-size: 12px; color:#cbd5e1; opacity:.85; }

    footer { text-align: center; padding: 10px; color: #9aa1a9; font-size: 12px; }
    a { color: #b5cdfb; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="badge">Tap AR → move to find a surface → tap to place</div>
    </header>

    <model-viewer
      id="viewer"
      src="/assets/model.glb"
      ios-src="/assets/model.usdz"
      alt="AR model"
      ar
      ar-modes="webxr scene-viewer quick-look"
      ar-placement="floor"
      ar-scale="fixed"
      camera-controls
      exposure="1"
      shadow-intensity="1"
      environment-image="neutral"
      poster=""
      autoplay
      tone-mapping="aces"
      interaction-prompt="auto"
    >
      <!-- Apple Quick Look anchor (used by iOS). href is set from ios-src at runtime. -->
      <a id="iosLink" rel="ar" slot="ar" href="/assets/model.usdz" aria-label="Open in AR"></a>
    </model-viewer>

    <!-- Explicit AR button that calls activateAR() (helps with iOS gesture requirements) -->
    <div class="controls">
      <button id="btnAR" type="button">View in your space</button>
    </div>

    <div class="hint"><div class="chip">Move to scan the floor, then tap to place. Drag to reposition; two‑finger rotate.</div></div>
    <div class="diag" id="diag"></div>

    <footer>Replace <code>/assets/model.glb</code> + <code>/assets/model.usdz</code> with your files. Works on Android (Scene Viewer/WebXR) and iPhone (Quick Look/WebXR).</footer>
  </div>

  <script>
    const mv = document.getElementById('viewer');
    const btnAR = document.getElementById('btnAR');
    const iosLink = document.getElementById('iosLink');
    const diag = document.getElementById('diag');

    // Ensure iOS link points to the same USDZ as ios-src and add Quick Look params
    const usdz = mv.getAttribute('ios-src');
    if (usdz) {
      const absolute = new URL(usdz, location.href).href;
      // Optional Quick Look params: disallow pinch-scaling + custom label
      iosLink.href = absolute + '#allowsContentScaling=0&callToAction=View%20in%20your%20space';
    }

    function log(s) { diag.textContent = s; }

    // Pressing our button always uses model‑viewer API (more reliable across browsers)
    btnAR.addEventListener('click', async () => {
      try {
        if (!mv.canActivateAR) {
          log('AR not available here. Try Safari (iOS) or Chrome (Android).');
          return;
        }
        await mv.activateAR();
      } catch (err) {
        log('activateAR() failed: ' + (err?.message || err));
      }
    });

    // Useful diagnostics
    mv.addEventListener('ar-status', (e) => {
      const { status, reason } = e.detail || {};
      log('ar-status: ' + status + (reason ? (' | reason: ' + reason) : ''));
      if (status === 'session-started' && navigator.vibrate) navigator.vibrate(10);
    });

    // Warn if embedded in an iframe without permissions (iOS blocks Quick Look in some in-app browsers)
    if (window !== window.top) {
      log('This page is in an iframe. iOS may block AR unless the iframe allows camera & xr-spatial-tracking.');
    }
  </script>
</body>
</html>
